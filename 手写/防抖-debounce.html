<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>防抖-debounce</title>
  </head>
  <body>
    <h3>复制加内容</h3>
    <h1>debounce分为 非立即执行版 和 立即执行版 两种</h1>
    <h2>平常用的大多数为 非立即执行版【需要一个timer变量】</br>
        立即执行版较为复杂，另需一个辅助变量帮助理解【共两个变量】</h2>
    <h3>
        非立即执行版：n秒内所有触发当做最后一次触发，较为简单；</br>
        立即执行版：【总结：我杀了我自己（timer杀timer）】
    </h3>
    <h3>addEventListener中的this指向</h3>

    <input type="text" id='input'>

  </body>
  <script>
    document.oncopy=(e)=>{
      // return false;//return false后不能复制到东西
      const selection = document.getSelection();
      e.clipboardData.setData('text/plain', selection.toString()+'sssssssssss');
      e.preventDefault();
    }
    function inputFn(e) {
      console.log("input输入内容的最后一位" + e.data);
      console.log(e.target.value);
    }
    let ipt = document.getElementById("input");
    // ipt.addEventListener('input',debounce(inputFn,1000))
    // ipt.addEventListener('input',debounceRightnow(inputFn,1000))
    ipt.addEventListener('input',firstDebounce(inputFn,1000))

    // 非立即执行版
    function debounce(fn, delay) {
      let timer;
      return function () {
        if (timer) clearTimeout(timer);
        timer = setTimeout(() => {
          console.log('debounce');
          fn.apply(this, arguments);
        }, delay);
      };
    }

    // 立即执行版   【下边首防抖的优化版】
    function debounceRightnow(fn, delay) {
      let timer;
      return function () {
        if (timer) clearTimeout(timer); //第二次才有这个，第一次直接跳过
        let callNow = !timer; //记录定时器之前的timer状态
        timer = setTimeout(() => {
          timer = null; //我杀了我自己【定时器只有这一个作用】
        }, delay);
        callNow && fn.apply(this, arguments);
      };
    }

    //首防抖  【记这个】
    function firstDebounce(fn,delay){
      let timer;
      let flag = true;
      
      return function(){
        if(timer) clearTimeout(timer);
        if(flag) {
          fn.apply(this,arguments);
          flag = false;
        }
        timer = setTimeout(() => {
          flag = true;
        }, delay);
      }
    }

    // 结合版【可选择版】
    /**
     * @desc 函数防抖
     * @param func 函数
     * @param wait 延迟执行毫秒数
     * @param immediate true 表立即执行，false 表非立即执行
     */
    function debounceFinal(func, wait, immediate) {
      let timeout;
      return function () {
        let context = this;
        let args = arguments;
        console.log(args);
        if (timeout) clearTimeout(timeout);
        if (immediate) {
          var callNow = !timeout;
          timeout = setTimeout(() => {
            timeout = null;
          }, wait);
          if (callNow) func.apply(context, args);
        } else {
          timeout = setTimeout(function () {
            func.apply(context, args);
          }, wait);
        }
      };
    }
  </script>
</html>
